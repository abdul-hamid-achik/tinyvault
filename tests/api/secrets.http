# TinyVault Secrets API Tests
# These tests verify secret CRUD operations

### Setup - Create Test Project
# @name setupProject
# @tags secrets, setup
# @auth bearer {{token}}
# @description Create a project for secret tests

POST {{baseUrl}}/projects
Content-Type: application/json

{
  "name": "secrets-test-{{$uuid()}}",
  "description": "Test project for secrets API tests"
}

>>>
expect status 201
expect body.data.id exists
expect duration < 1000
<<<

>>>capture
projectId from body.data.id
<<<

### List Secrets - Empty Project
# @name listSecretsEmpty
# @tags secrets, read
# @depends setupProject
# @auth bearer {{token}}
# @description New project should have no secrets

GET {{baseUrl}}/projects/{{setupProject.projectId}}/secrets

>>>
expect status 200
expect body.data exists
expect body.data type array
expect body.data length 0
expect duration < 1000
<<<

### Set Secret - Create New
# @name createSecret
# @tags secrets, write
# @depends setupProject
# @auth bearer {{token}}
# @description Create a new secret

PUT {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/DATABASE_URL
Content-Type: application/json

{
  "value": "postgres://test:test@localhost:5432/testdb"
}

>>>
expect status 200
expect body.data exists
expect body.data.id exists
expect body.data.key == "DATABASE_URL"
expect body.data.value == "postgres://test:test@localhost:5432/testdb"
expect body.data.version == 1
expect body.data.created_at exists
expect body.data.updated_at exists
expect duration < 1000
<<<

>>>capture
secretId from body.data.id
<<<

### Get Secret
# @name getSecret
# @tags secrets, read
# @depends createSecret
# @auth bearer {{token}}
# @description Get a specific secret with decrypted value

GET {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/DATABASE_URL

>>>
expect status 200
expect body.data exists
expect body.data.key == "DATABASE_URL"
expect body.data.value == "postgres://test:test@localhost:5432/testdb"
expect body.data.version == 1
expect duration < 500
<<<

### Update Secret
# @name updateSecret
# @tags secrets, write
# @depends createSecret
# @auth bearer {{token}}
# @description Update an existing secret

PUT {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/DATABASE_URL
Content-Type: application/json

{
  "value": "postgres://prod:prod@prodhost:5432/proddb"
}

>>>
expect status 200
expect body.data exists
expect body.data.key == "DATABASE_URL"
expect body.data.value == "postgres://prod:prod@prodhost:5432/proddb"
expect body.data.version == 2
expect duration < 1000
<<<

### Create Second Secret
# @name createSecondSecret
# @tags secrets, write
# @depends setupProject
# @auth bearer {{token}}
# @description Create another secret for testing list/export

PUT {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/API_KEY
Content-Type: application/json

{
  "value": "sk_test_{{$randomString(32)}}"
}

>>>
expect status 200
expect body.data.key == "API_KEY"
expect body.data.version == 1
<<<

### List Secrets
# @name listSecrets
# @tags secrets, read
# @depends createSecondSecret
# @auth bearer {{token}}
# @description List all secrets (metadata only, no values)

GET {{baseUrl}}/projects/{{setupProject.projectId}}/secrets

>>>
expect status 200
expect body.data exists
expect body.data type array
expect body.data length 2
expect duration < 1000
<<<

### Export Secrets
# @name exportSecrets
# @tags secrets, read
# @depends createSecondSecret
# @auth bearer {{token}}
# @description Export all secrets with decrypted values

GET {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/export

>>>
expect status 200
expect body.data exists
expect body.data type object
expect body.data.DATABASE_URL exists
expect body.data.API_KEY exists
expect duration < 1000
<<<

### Get Secret - Not Found
# @name getSecretNotFound
# @tags secrets, errors
# @depends setupProject
# @auth bearer {{token}}
# @description Non-existent secret should return 404

GET {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/NONEXISTENT_KEY

>>>
expect status 404
expect body.error exists
expect body.error.code == "NOT_FOUND"
<<<

### Set Secret - Invalid Key Format
# @name setSecretInvalidKey
# @tags secrets, errors
# @depends setupProject
# @auth bearer {{token}}
# @description Secret key with invalid format should return 400

PUT {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/123-invalid-key
Content-Type: application/json

{
  "value": "some value"
}

>>>
expect status 400
expect body.error exists
<<<

### Set Secret - Missing Value
# @name setSecretMissingValue
# @tags secrets, errors
# @depends setupProject
# @auth bearer {{token}}
# @description Secret without value should return 400

PUT {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/EMPTY_SECRET
Content-Type: application/json

{}

>>>
expect status 400
expect body.error exists
<<<

### Delete Secret
# @name deleteSecret
# @tags secrets, delete
# @depends updateSecret
# @auth bearer {{token}}
# @description Delete a secret

DELETE {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/DATABASE_URL

>>>
expect status 204
expect duration < 500
<<<

### Verify Secret Deleted
# @name verifySecretDeleted
# @tags secrets, delete
# @depends deleteSecret
# @auth bearer {{token}}
# @description Verify secret no longer exists

GET {{baseUrl}}/projects/{{setupProject.projectId}}/secrets/DATABASE_URL

>>>
expect status 404
<<<

### Secrets for Non-existent Project
# @name secretsNonexistentProject
# @tags secrets, errors
# @auth bearer {{token}}
# @description Accessing secrets for non-existent project should return 404

GET {{baseUrl}}/projects/00000000-0000-0000-0000-000000000000/secrets

>>>
expect status 404
<<<

### Cleanup - Delete Test Project
# @name cleanupProject
# @tags secrets, cleanup
# @depends verifySecretDeleted
# @auth bearer {{token}}
# @description Clean up test project

DELETE {{baseUrl}}/projects/{{setupProject.projectId}}

>>>
expect status 204
<<<
