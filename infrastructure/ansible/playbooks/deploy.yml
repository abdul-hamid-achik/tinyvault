---
# TinyVault Production Deployment Playbook
- name: Deploy TinyVault
  hosts: all
  become: yes
  vars:
    app_dir: /opt/tinyvault
    postgres_mount: /mnt/postgres
    data_mount: /mnt/data
  vars_files:
    - ../vars/production.yml

  tasks:
    - name: Wait for cloud-init to complete
      command: cloud-init status --wait
      changed_when: false
      timeout: 300

    - name: Ensure mount directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ postgres_mount }}"
        - "{{ data_mount }}"
        - "{{ data_mount }}/redis"

    - name: Check if postgres volume is mounted
      command: mountpoint -q {{ postgres_mount }}
      register: postgres_mounted
      failed_when: false
      changed_when: false

    - name: Check if data volume is mounted
      command: mountpoint -q {{ data_mount }}
      register: data_mounted
      failed_when: false
      changed_when: false

    - name: Get postgres volume device
      shell: ls /dev/disk/by-id/ | grep -E 'scsi-0HC_Volume_[0-9]+' | head -1
      register: postgres_volume_device
      when: postgres_mounted.rc != 0
      changed_when: false

    - name: Get data volume device
      shell: ls /dev/disk/by-id/ | grep -E 'scsi-0HC_Volume_[0-9]+' | tail -1
      register: data_volume_device
      when: data_mounted.rc != 0
      changed_when: false

    - name: Mount postgres volume
      mount:
        path: "{{ postgres_mount }}"
        src: "/dev/disk/by-id/{{ postgres_volume_device.stdout }}"
        fstype: ext4
        state: mounted
        opts: defaults,noatime
      when: postgres_mounted.rc != 0 and postgres_volume_device.stdout is defined and postgres_volume_device.stdout != ""

    - name: Mount data volume
      mount:
        path: "{{ data_mount }}"
        src: "/dev/disk/by-id/{{ data_volume_device.stdout }}"
        fstype: ext4
        state: mounted
        opts: defaults,noatime
      when: data_mounted.rc != 0 and data_volume_device.stdout is defined and data_volume_device.stdout != ""

    - name: Ensure Redis data directory exists with proper permissions
      file:
        path: "{{ data_mount }}/redis"
        state: directory
        mode: '0755'

    - name: Install required packages
      apt:
        name:
          - docker.io
          - docker-compose-v2
          - python3-docker
        state: present
        update_cache: yes

    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'

    - name: Copy docker-compose.yml
      copy:
        src: ../../../docker-compose.yml
        dest: "{{ app_dir }}/docker-compose.yml"
        mode: '0644'

    - name: Copy Caddyfile
      copy:
        src: ../../../Caddyfile
        dest: "{{ app_dir }}/Caddyfile"
        mode: '0644'

    - name: Copy environment file
      template:
        src: ../templates/env.j2
        dest: "{{ app_dir }}/.env"
        mode: '0600'

    - name: Login to GitHub Container Registry
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ lookup('env', 'GHCR_USERNAME') | default('abdul-hamid-achik', true) }}"
        password: "{{ lookup('env', 'GHCR_TOKEN') }}"
      when: lookup('env', 'GHCR_TOKEN') != ''

    - name: Pull latest images
      command: docker compose pull
      args:
        chdir: "{{ app_dir }}"
      changed_when: true

    - name: Start services with prod profile
      command: docker compose --profile prod up -d --remove-orphans
      args:
        chdir: "{{ app_dir }}"
      changed_when: true

    - name: Wait for app to be healthy
      uri:
        url: "http://localhost:8080/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 30
      delay: 5
      until: health_check.status == 200

    - name: Show deployment status
      debug:
        msg: |
          Deployment complete!
          - App: https://{{ domain }}
          - Health: {{ health_check.status }}
